# Use a Node.js Docker image
image: node:18

# Cache dependencies
cache:
  key: cache-dependencies
  paths:
    - node_modules/

.standard-rules:
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop"
      when: always

# Define stages
stages:
  - install
  - build
  - test

# Install dependencies
install_dependencies:
  stage: install
  extends: .standard-rules
  script:
    - echo "Installing dependencies..."
    - npm ci
  cache:
    policy: push

# Build the project
build_project:
  stage: build
  extends: .standard-rules
  script:
    - echo "Building the project..."
    - npm run build
  cache:
    policy: pull
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

# Run tests
run_tests:
  stage: test
  extends: .standard-rules
  script:
    - echo "Running tests..."
    - npm run test
    - npm run test:e2e # Add this if you have e2e tests
  cache:
    policy: pull

# Optional: Linting stage
lint_code:
  extends: .standard-rules
  stage: test
  script:
    - echo "Running lint..."
    - npm run lint
  allow_failure: true